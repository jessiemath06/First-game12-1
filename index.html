<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessie Math - é€Ÿç‡å¤§æŒ‘æˆ°PRO</title>

    <!-- å¿«å–é€£çµé è¦½ -->
    <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta property="og:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        :root {
            --primary-color: #F4D03F; /* Jessie Math å“ç‰Œé»ƒ */
            --text-color: #333333;    /* å“ç‰Œæ·±ç°/é»‘ */
            --accent-color: #E74C3C;
            --blue-accent: #5DADE2;   /* æˆªåœ–ä¸­çš„è—è‰² */
            --bg-color: #f9f9f9;
            --header-height: 80px;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header / Hero å€åŸŸ (ä¾æˆªåœ–ä¿®æ”¹) --- */
        header {
            background-color: #fff;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
            gap: 16px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 180px;
        }

        .logo-circle {
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            flex: 0 0 auto;
        }

        .logo-circle img {
            width: 85%;
            height: auto;
            object-fit: contain;
        }

        .brand-name {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-color);
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        nav {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        /* ä¸€èˆ¬å°èˆªæŒ‰éˆ• */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 20px;
            transition: background 0.3s;
            white-space: nowrap;
        }
        .nav-item:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        /* ç‰¹æ®Šè—è‰²å¤–æ¡†æŒ‰éˆ• (æˆªåœ–æ¨£å¼) */
        .nav-btn-outline {
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: #4a69bd;
            font-size: 15px;
            font-weight: 700;
            padding: 6px 15px;
            border: 1.5px solid #4a69bd;
            border-radius: 50px;
            transition: all 0.3s;
            background: white;
            white-space: nowrap;
        }
        .nav-btn-outline:hover {
            background-color: #4a69bd;
            color: white;
            box-shadow: 0 4px 10px rgba(74, 105, 189, 0.3);
        }

        /* --- éŠæˆ²ä¸»å®¹å™¨ --- */
        .game-container {
            flex: 1;
            max-width: 800px;
            width: 95%;
            margin: 30px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            animation: fadeIn 0.4s ease-out;
            flex: 1;
        }

        .screen.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { color: var(--text-color); margin-bottom: 10px; }
        h2 { color: var(--text-color); }
        p { color: #666; line-height: 1.6; }

        input[type="text"] {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            width: 100%;
            max-width: 300px;
            margin: 20px 0;
            text-align: center;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary-color); }

        .btn {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 0 #d4b10b;
            margin: 5px;
            display: inline-block;
            min-width: 100px;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #d4b10b; }

        .btn.secondary { background-color: #eee; box-shadow: 0 4px 0 #ccc; }
        .btn.secondary:active { transform: translateY(4px); box-shadow: 0 0 0 #ccc; }

        .btn.danger { background-color: #ffcccc; color: #c0392b; box-shadow: 0 4px 0 #e6b0aa; }
        .btn.danger:active { transform: translateY(4px); box-shadow: 0 0 0 #e6b0aa; }

        /* é¸æ“‡é—œå¡æ¨£å¼ */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }

        .select-card {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .select-card:hover { border-color: var(--primary-color); transform: translateY(-3px); }
        .select-card.selected {
            background-color: #fff9db;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(244, 208, 63, 0.3);
        }
        .select-card i { font-size: 2em; margin-bottom: 10px; display: block; }

        .difficulty-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .diff-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: bold;
        }
        .diff-btn.selected {
            background: var(--primary-color);
            border-color: #d4b10b;
        }

        /* éŠæˆ²å…§ä»‹é¢ HUD */
        .hud-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #34495e;
            color: white;
            border-radius: 15px;
            margin-bottom: 15px;
            font-weight: bold;
            box-shadow: 0 4px 0 #2c3e50;
            gap: 10px;
            flex-wrap: wrap;
        }
        .hud-item { display: flex; align-items: center; gap: 8px; }
        .hud-item span { font-size: 1.2em; color: #F4D03F; }

        /* Combo æ¨£å¼ */
        .combo-box {
            background: #e74c3c;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.9em;
            display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
        }
        .combo-box.active { display: block; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* æƒ…å¢ƒæ’åœ–å¡ */
        .scenario-card {
            width: 100%;
            height: 140px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            margin-bottom: -10px;
            z-index: 1;
        }

        .scene-sky { background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%); }
        .scene-road { background: linear-gradient(135deg, #304352 0%, #d7d2cc 100%); border-bottom: 10px dashed #fff; }
        .scene-nature { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .scene-track { background: linear-gradient(to right, #e67e22, #f1c40f); }
        .scene-water { background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); }

        .scenario-icon {
            font-size: 5em;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .question-area {
            background: #fff;
            border: 2px solid #eee;
            border-top: none;
            padding: 20px;
            border-radius: 0 0 20px 20px;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            position: relative;
        }

        .q-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 2;
            white-space: nowrap;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .option-card {
            background: white;
            border: 2px solid #eee;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            user-select: none;
        }
        .option-card:hover {
            border-color: var(--primary-color);
            background: #fffdf0;
            transform: translateY(-2px);
        }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        .leaderboard-box {
            margin-top: 16px;
            width: 100%;
            max-width: 520px;
            border-top: 2px solid #eee;
            padding-top: 15px;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .leaderboard-table th {
            text-align: left;
            padding: 8px;
            color: #888;
        }
        .leaderboard-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .rank-1 { color: #f1c40f; font-weight: bold; }
        .rank-2 { color: #95a5a6; font-weight: bold; }
        .rank-3 { color: #d35400; font-weight: bold; }

        .game-btn-group {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* --- æš«åœé®ç½©ï¼ˆé®è“‹é¡Œç›®ï¼‰ --- */
        .pause-overlay{
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.72);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 18px;
        }
        .pause-overlay.active{ display:flex; }
        .pause-card{
            width: min(520px, 92%);
            background: rgba(255,255,255,.92);
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 18px;
            box-shadow: 0 20px 55px rgba(0,0,0,.25);
            padding: 18px 16px;
            text-align: center;
        }
        .pause-title{
            font-size: 22px;
            font-weight: 900;
            color: #0f172a;
            margin-bottom: 6px;
        }
        .pause-sub{
            color:#475569;
            font-weight: 700;
            margin: 0 0 12px;
        }

        /* âœ… å›é¥‹ Toastï¼ˆç­”å°/ç­”éŒ¯éƒ½æœƒå‡ºç¾ï¼‰ */
        .toast{
            position: absolute;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            width: min(640px, 92%);
            background: rgba(255,255,255,.94);
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 16px;
            box-shadow: 0 14px 40px rgba(0,0,0,.14);
            padding: 12px 14px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            z-index: 998;
        }
        .toast.active{ display:flex; }
        .toast-left{
            display:flex;
            align-items:flex-start;
            gap: 10px;
            text-align:left;
        }
        .toast-emoji{ font-size: 22px; line-height: 1; margin-top: 2px; }
        .toast-title{ font-weight: 900; color:#0f172a; margin-bottom: 2px; }
        .toast-msg{ color:#475569; font-weight: 700; font-size: 14px; }
        .toast-btn{
            border: none;
            background: var(--primary-color);
            color:#000;
            font-weight: 900;
            padding: 10px 14px;
            border-radius: 999px;
            cursor: pointer;
            box-shadow: 0 4px 0 #d4b10b;
            flex: 0 0 auto;
        }
        .toast-btn:active{ transform: translateY(4px); box-shadow: 0 0 0 #d4b10b; }

        /* --- Footerï¼ˆä½ æŒ‡å®šçš„æ¨£å¼ï¼‰ --- */
        footer{
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 18px 12px 26px;
        }
        .footer-pill{
            width: min(980px, 96%);
            background: rgba(255,255,255,.88);
            border: 1px solid rgba(0,0,0,.06);
            box-shadow: 0 10px 26px rgba(0,0,0,.08);
            border-radius: 999px;
            padding: 12px 16px;
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        .footer-left, .footer-right{
            display:flex;
            align-items:center;
            gap: 10px;
        }
        .footer-dot{
            width:10px;height:10px;border-radius:50%;
            background: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(244,208,63,.25);
        }
        .footer-copy{
            color:#334155;
            font-weight: 700;
            font-size: 14px;
        }
        .footer-icon{
            width:28px;height:28px;border-radius: 10px;
            display:flex;align-items:center;justify-content:center;
            background: rgba(93,173,226,.18);
            color:#2c3e50;
        }
        .footer-tagline{
            color:#475569;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: .2px;
        }

        /* RWD Mobile */
        @media (max-width: 600px) {
            header { padding: 8px 15px; height: auto; }
            .brand-name { font-size: 18px; }
            .nav-item span { display: none; }
            .nav-btn-outline span { display: inline; }

            .options-grid { grid-template-columns: 1fr; }
            .game-container { padding: 20px 15px; margin: 15px auto; width: 95%; }
            .btn { flex: 1; padding: 12px 10px; font-size: 14px; }

            .footer-pill{ border-radius: 22px; }
        }

        /* RWD Tablet */
        @media (min-width: 601px) and (max-width: 900px){
            header { padding: 10px 18px; height: auto; }
            .game-container{ margin: 18px auto; padding: 22px; }
            .hud-bar{ padding: 12px 14px; }
            .option-card{ font-size: 1.1em; }
            .footer-pill{ width: 94%; }
        }

        @media (min-width: 1200px){
            .game-container{ max-width: 860px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <div class="logo-circle">
                <img src="JESSIEMATH-Q.png" alt="Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4762/4762311.png'">
            </div>
            <div class="brand-name">Jessie Math</div>
        </div>

        <nav>
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-item">
                <i class="fas fa-home"></i>
                <span>é¦–é </span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-item">
                <i class="fas fa-gamepad"></i>
                <span>éŠæˆ²å¤§å»³</span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g6-u12" class="nav-btn-outline">
                <i class="fas fa-chevron-left"></i>
                <span>å…­å¹´ç´šé€Ÿç‡</span>
            </a>
        </nav>
    </header>

    <div class="game-container">

        <div id="screen-login" class="screen active">
            <h1 style="font-size: 2.5em;">ğŸï¸ é€Ÿç‡å¤§æŒ‘æˆ°</h1>
            <p>è¼¸å…¥ä½ çš„ä»£è™Ÿï¼ŒæŒ‘æˆ°é€£æ“Š Comboï¼</p>
            <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥åå­— (æœ€å¤š10å­—)" maxlength="10">
            <button class="btn" onclick="goToSelection()">ä¸‹ä¸€æ­¥</button>
        </div>

        <div id="screen-selection" class="screen">
            <h2>é¸æ“‡ä¿®ç·´ä¸»é¡Œ</h2>
            <div class="selection-grid">
                <div class="select-card" onclick="selectLevel(1, this)">
                    <i class="fas fa-rocket" style="color:#e67e22"></i>
                    <div>Level 1<br>è·é›¢</div>
                </div>
                <div class="select-card" onclick="selectLevel(2, this)">
                    <i class="fas fa-stopwatch" style="color:#3498db"></i>
                    <div>Level 2<br>æ™‚é–“</div>
                </div>
                <div class="select-card" onclick="selectLevel(3, this)">
                    <i class="fas fa-tachometer-alt" style="color:#e74c3c"></i>
                    <div>Level 3<br>é€Ÿç‡</div>
                </div>
                <div class="select-card" onclick="selectLevel(4, this)">
                    <i class="fas fa-running" style="color:#2ecc71"></i>
                    <div>Level 4<br>è¿½è¶•</div>
                </div>
                <div class="select-card selected" onclick="selectLevel(5, this)">
                    <i class="fas fa-random" style="color:#9b59b6"></i>
                    <div>Level 5<br>æ··åˆæŒ‘æˆ°</div>
                </div>
            </div>

            <h2>é¸æ“‡è»Šé€Ÿ (é›£åº¦)</h2>
            <div class="difficulty-options">
                <button class="diff-btn" onclick="selectDiff('easy', this)">ğŸ˜Š è¼•é¬†</button>
                <button class="diff-btn selected" onclick="selectDiff('normal', this)">ğŸ˜ æ¨™æº–</button>
                <button class="diff-btn" onclick="selectDiff('hard', this)">ğŸ”¥ æ¥µé€Ÿ</button>
            </div>

            <div class="leaderboard-box">
                <h3>ğŸ† è‹±é›„æ¦œ</h3>
                <table class="leaderboard-table" id="selection-leaderboard"></table>
            </div>

            <div class="game-btn-group">
                <button class="btn secondary" onclick="switchScreen('screen-login')">è¿”å›</button>
                <button class="btn" onclick="startGame()">é–‹å§‹ GO!</button>
            </div>
        </div>

        <div id="screen-game" class="screen">
            <div class="hud-bar">
                <div class="hud-item"><i class="fas fa-user"></i> <span id="hud-name">Player</span></div>
                <div class="hud-item">
                    <i class="fas fa-star"></i>
                    <span id="hud-score">0</span>
                    <div id="combo-display" class="combo-box">Combo x2!</div>
                </div>
                <div class="hud-item"><i class="fas fa-clock"></i> <span id="hud-timer">00:00</span></div>
            </div>

            <div class="scenario-card" id="scene-bg">
                <div class="scenario-icon" id="q-emoji">ğŸš€</div>
            </div>

            <div class="question-area">
                <div class="q-badge" id="q-title">é¡Œç›®ä¸»é¡Œ</div>
                <div id="q-text" style="font-size: 1.4em; margin: 15px 0; font-weight: bold; color:#2c3e50;">
                    é¡Œç›®è¼‰å…¥ä¸­...
                </div>

                <div class="options-grid" id="q-options"></div>
            </div>

            <div class="game-btn-group">
                <button class="btn secondary" onclick="backToMenu()">â‰¡ é¸é—œå¡</button>
                <button class="btn secondary" onclick="pauseGame()">æš«åœ</button>
                <button class="btn danger" onclick="restartGame()">é‡ä¾†</button>
            </div>

            <div id="pause-overlay" class="pause-overlay" aria-hidden="true">
                <div class="pause-card">
                    <div class="pause-title">â¸ï¸ æš«åœä¸­</div>
                    <p class="pause-sub">é¡Œç›®å…ˆèº²èµ·ä¾†ï½ä¼‘æ¯ä¸€ä¸‹å†å›ä¾†å¸¥ä¸€æ³¢ ğŸ˜</p>
                    <div class="game-btn-group" style="margin-top:10px;">
                        <button class="btn" onclick="pauseGame()">ç¹¼çºŒ</button>
                        <button class="btn secondary" onclick="restartGame()">é‡ä¾†</button>
                        <button class="btn secondary" onclick="backToMenu()">å›é¸é—œå¡</button>
                    </div>
                </div>
            </div>

            <!-- âœ… ç­”é¡Œå›é¥‹ Toastï¼ˆä¸æ”¹ç‰ˆé¢ï¼Œåªæµ®åœ¨åº•éƒ¨ï¼‰ -->
            <div id="toast" class="toast" aria-live="polite">
                <div class="toast-left">
                    <div id="toast-emoji" class="toast-emoji">âœ…</div>
                    <div>
                        <div id="toast-title" class="toast-title">å¤ªçŒ›äº†ï¼</div>
                        <div id="toast-msg" class="toast-msg">æº–å‚™ä¸‹ä¸€é¡Œï½</div>
                    </div>
                </div>
                <button id="toast-btn" class="toast-btn" onclick="toastNext()">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <h1>æ™‚é–“åˆ°ï¼</h1>

            <div class="stars-display" id="result-stars">
                <span>â˜…</span><span>â˜…</span><span>â˜…</span>
            </div>

            <h2>å¾—åˆ†: <span id="final-score" style="color:var(--accent-color);">0</span></h2>
            <p id="feedback-msg">è©•èª...</p>

            <div class="game-btn-group">
                <button class="btn" onclick="switchScreen('screen-selection')">å†ç©ä¸€æ¬¡</button>
                <button class="btn secondary" onclick="window.location.href='https://jessiemath0703-chu.github.io/website2/'">å›é¦–é </button>
            </div>
        </div>

    </div>

    <footer>
        <div class="footer-pill">
            <div class="footer-left">
                <div class="footer-dot" aria-hidden="true"></div>
                <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
            </div>
            <div class="footer-right">
                <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
                <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
            </div>
        </div>
    </footer>

    <script>
        // --- éŠæˆ²è³‡æ–™ ---
        let gameState = {
            name: "Player",
            score: 0,
            combo: 0,
            time: 0,
            timerId: null,
            level: 5,
            difficulty: 'normal',
            isPaused: false,
            currentQ: null
        };

        const BASE_TIME = 60;

        // âœ… å›é¥‹æ§åˆ¶ï¼šé¡¯ç¤ºå¾Œã€ŒæŒ‰ä¸‹ä¸€é¡Œã€æ‰æœƒå‡ºé¡Œï¼ˆç¬¦åˆï¼šç­”å°/ç­”éŒ¯éƒ½è¦å›é¥‹ï¼Œå†é€²ä¸‹ä¸€é¡Œï¼‰
        let awaitingNext = false;
        let pendingNextFn = null;

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if(screenId !== 'screen-game') hidePauseOverlay();
            hideToast();
        }

        function goToSelection() {
            const name = document.getElementById('player-name').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
            gameState.name = name;
            switchScreen('screen-selection');
            renderLeaderboard('selection-leaderboard');
        }

        function selectLevel(lvl, el) {
            gameState.level = lvl;
            document.querySelectorAll('.select-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function selectDiff(diff, el) {
            gameState.difficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function startGame() {
            gameState.score = 0;
            gameState.combo = 0;
            updateComboUI();

            if(gameState.difficulty === 'easy') gameState.time = Math.round(BASE_TIME * 1.5);
            else if(gameState.difficulty === 'hard') gameState.time = Math.round(BASE_TIME * 0.8);
            else gameState.time = BASE_TIME;

            gameState.isPaused = false;
            hidePauseOverlay();

            awaitingNext = false;
            pendingNextFn = null;
            hideToast();

            document.getElementById('hud-name').textContent = gameState.name;
            switchScreen('screen-game');

            generateNextQuestion();   // âœ… å…ˆå‡ºç¬¬ä¸€é¡Œ
            startTimer();
        }

        function restartGame() {
            if(confirm("ç¢ºå®šè¦é‡ä¾†å—ï¼Ÿç›®å‰åˆ†æ•¸æœƒæ­¸é›¶å–”ï¼")) {
                clearInterval(gameState.timerId);
                startGame();
            }
        }

        function backToMenu() {
            if(confirm("ç¢ºå®šè¦çµæŸç›®å‰éŠæˆ²ï¼Œå›åˆ°ä¸»é¡Œé¸å–®å—ï¼Ÿ")) {
                clearInterval(gameState.timerId);
                gameState.isPaused = false;
                hidePauseOverlay();
                awaitingNext = false;
                pendingNextFn = null;
                hideToast();
                switchScreen('screen-selection');
                renderLeaderboard('selection-leaderboard');
            }
        }

        function startTimer() {
            if(gameState.timerId) clearInterval(gameState.timerId);
            updateTimerUI();
            gameState.timerId = setInterval(() => {
                if(!gameState.isPaused) {
                    gameState.time--;
                    updateTimerUI();
                    if(gameState.time <= 0) endGame();
                }
            }, 1000);
        }

        function updateTimerUI() {
            let m = Math.floor(gameState.time / 60);
            let s = Math.floor(gameState.time % 60);
            document.getElementById('hud-timer').textContent =
                `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

            if(gameState.time < 10) document.getElementById('hud-timer').style.color = '#e74c3c';
            else document.getElementById('hud-timer').style.color = 'white';
        }

        function showPauseOverlay(){
            const o = document.getElementById('pause-overlay');
            if(o){ o.classList.add('active'); o.setAttribute('aria-hidden','false'); }
        }
        function hidePauseOverlay(){
            const o = document.getElementById('pause-overlay');
            if(o){ o.classList.remove('active'); o.setAttribute('aria-hidden','true'); }
        }

        function pauseGame() {
            gameState.isPaused = !gameState.isPaused;
            if(gameState.isPaused){
                showPauseOverlay();
            }else{
                hidePauseOverlay();
            }
        }

        function updateComboUI() {
            const box = document.getElementById('combo-display');
            if (gameState.combo > 1) {
                box.textContent = `ğŸ”¥ Combo x${gameState.combo}`;
                box.classList.add('active');
                box.style.animation = 'none';
                box.offsetHeight;
                box.style.animation = 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            } else {
                box.classList.remove('active');
            }
        }

        // âœ… Toastï¼šç­”å°å›é¥‹ / ç­”éŒ¯çµ¦æ­£ç¢ºç­”æ¡ˆï¼ˆç„¶å¾ŒæŒ‰ä¸‹ä¸€é¡Œå†é€²ä¸‹ä¸€é¡Œï¼‰
        function showToast({emoji, title, msg, btnText="ä¸‹ä¸€é¡Œ"}){
            const t = document.getElementById('toast');
            document.getElementById('toast-emoji').textContent = emoji;
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-msg').innerHTML = msg;
            document.getElementById('toast-btn').textContent = btnText;
            t.classList.add('active');
        }
        function hideToast(){
            const t = document.getElementById('toast');
            if(t) t.classList.remove('active');
        }
        function toastNext(){
            if(!awaitingNext) return;
            hideToast();
            awaitingNext = false;
            const fn = pendingNextFn;
            pendingNextFn = null;
            if(typeof fn === "function") fn();
        }

        // --- é¡Œç›®éš¨æ©Ÿ + è®ŠåŒ–ï¼ˆä¿æŒä½ ä¸Šä¸€ç‰ˆï¼‰ ---
        function generateNextQuestion() {
            let type = gameState.level === 5 ? Math.floor(Math.random()*6)+1 : gameState.level;
            let q = {};

            const randItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const rdm = (min, max) => Math.floor(Math.random()*(max-min+1)+min);

            if(type === 1) {
                const scenarios = [
                    { name: "ç«ç®­", emoji: "ğŸš€", speed: [500, 900], time: [2, 5], scene: "scene-sky", unitS:"å…¬é‡Œ/æ™‚", unitT:"å°æ™‚", unitA:"å…¬é‡Œ" },
                    { name: "é«˜éµ", emoji: "ğŸš…", speed: [200, 300], time: [2, 4], scene: "scene-track", unitS:"å…¬é‡Œ/æ™‚", unitT:"å°æ™‚", unitA:"å…¬é‡Œ" },
                    { name: "çµè±¹", emoji: "ğŸ†", speed: [60, 110], time: [2, 5], scene: "scene-nature", unitS:"å…¬é‡Œ/æ™‚", unitT:"å°æ™‚", unitA:"å…¬é‡Œ" },
                    { name: "è€é·¹", emoji: "ğŸ¦…", speed: [100, 150], time: [3, 6], scene: "scene-sky", unitS:"å…¬é‡Œ/æ™‚", unitT:"å°æ™‚", unitA:"å…¬é‡Œ" },
                    { name: "åª½åª½å¥èµ°", emoji: "ğŸš¶â€â™€ï¸", speed: [60, 120], time: [10, 30], scene: "scene-road", unitS:"å…¬å°º/åˆ†", unitT:"åˆ†é˜", unitA:"å…¬å°º" },
                    { name: "è·‘æ­¥è¨“ç·´", emoji: "ğŸƒâ€â™‚ï¸", speed: [120, 220], time: [10, 25], scene: "scene-track", unitS:"å…¬å°º/åˆ†", unitT:"åˆ†é˜", unitA:"å…¬å°º" }
                ];
                let sObj = randItem(scenarios);
                let s = rdm(sObj.speed[0], sObj.speed[1]);
                let t = rdm(sObj.time[0], sObj.time[1]);
                q = {
                    ...sObj,
                    title: "Level 1: è·é›¢è¨ˆç®—",
                    text: `${sObj.name}çš„é€Ÿç‡æ˜¯ <b>${s} ${sObj.unitS}</b>ï¼Œ<br>æŒçºŒç§»å‹•äº† <b>${t} ${sObj.unitT}</b>ã€‚<br>è«‹å•ç§»å‹•äº†å¤šé ï¼Ÿ`,
                    ans: s * t,
                    unit: sObj.unitA,
                    opts: genOpts(s*t, Math.max(3, Math.round((s*t)*0.08)))
                };
            }
            else if(type === 2) {
                const scenarios = [
                    { name: "å¤–é€å“¡", emoji: "ğŸ›µ", speed: [400, 600], scene: "scene-road", unitS:"å…¬å°º/åˆ†", unitA:"åˆ†é˜" },
                    { name: "é¨è…³è¸è»Š", emoji: "ğŸš²", speed: [200, 300], scene: "scene-nature", unitS:"å…¬å°º/åˆ†", unitA:"åˆ†é˜" },
                    { name: "éŠè‰‡", emoji: "ğŸš¤", speed: [50, 80], scene: "scene-water", unitS:"å…¬é‡Œ/æ™‚", unitA:"å°æ™‚" },
                    { name: "å…¬åœ’å¥èµ°", emoji: "ğŸš¶", speed: [80, 120], scene: "scene-road", unitS:"å…¬å°º/åˆ†", unitA:"åˆ†é˜" }
                ];
                let sObj = randItem(scenarios);
                let timeAns = rdm(4, 15);
                let speed = rdm(sObj.speed[0], sObj.speed[1]);

                let dist, distUnit, text;
                if(sObj.unitS === "å…¬é‡Œ/æ™‚"){
                    dist = speed * timeAns;
                    distUnit = "å…¬é‡Œ";
                    text = `${sObj.name}è¦ç§»å‹• <b>${dist} ${distUnit}</b>ï¼Œ<br>é€Ÿç‡æ˜¯ <b>${speed} ${sObj.unitS}</b>ã€‚<br>è«‹å•éœ€è¦å¹¾å°æ™‚ï¼Ÿ`;
                }else{
                    dist = speed * timeAns;
                    distUnit = "å…¬å°º";
                    text = `${sObj.name}è¦ç§»å‹• <b>${dist} ${distUnit}</b>ï¼Œ<br>é€Ÿç‡æ˜¯ <b>${speed} ${sObj.unitS}</b>ã€‚<br>è«‹å•éœ€è¦å¹¾åˆ†é˜ï¼Ÿ`;
                }

                q = {
                    ...sObj,
                    title: "Level 2: æ™‚é–“è¨ˆç®—",
                    text,
                    ans: timeAns,
                    unit: sObj.unitA,
                    opts: genOpts(timeAns, 3)
                };
            }
            else if(type === 3) {
                const scenarios = [
                    { name: "çƒé¾œ", emoji: "ğŸ¢", unit: "å…¬åˆ†/ç§’", scene: "scene-nature", mode:"basic" },
                    { name: "è·‘è»Š", emoji: "ğŸï¸", unit: "å…¬å°º/ç§’", scene: "scene-road", mode:"basic" },
                    { name: "äººé€ è¡›æ˜Ÿ", emoji: "ğŸ›°ï¸", unit: "å…¬é‡Œ/ç§’", scene: "scene-sky", mode:"basic" },
                    { name: "å»å›è·‘æ­¥", emoji: "ğŸ”", unit: "å…¬å°º/åˆ†", scene: "scene-track", mode:"avg_roundtrip" },
                    { name: "æ—…ç¨‹å¹³å‡", emoji: "ğŸ§­", unit: "å…¬é‡Œ/æ™‚", scene: "scene-road", mode:"avg_total" }
                ];
                let sObj = randItem(scenarios);

                if(sObj.mode === "basic"){
                    let time = rdm(5, 20);
                    let speed = rdm(10, 50);
                    let dist = speed * time;
                    q = {
                        ...sObj,
                        title: "Level 3: é€Ÿç‡è¨ˆç®—",
                        text: `${sObj.name}ç§»å‹•äº† <b>${dist}</b>ï¼ˆè·é›¢ï¼‰ï¼Œ<br>èŠ±äº† <b>${time} ç§’</b>ã€‚<br>è«‹å•é€Ÿç‡æ˜¯å¤šå°‘ï¼Ÿ`,
                        ans: speed,
                        unit: sObj.unit,
                        opts: genOpts(speed, 6)
                    };
                }
                else if(sObj.mode === "avg_roundtrip"){
                    let distOneWay = randItem([2400, 3000, 3600, 4200]);
                    let v1 = randItem([150, 180, 200, 240]);
                    let v2 = randItem([100, 120, 140, 160]);
                    if(distOneWay % v1 !== 0 || distOneWay % v2 !== 0){
                        distOneWay = 3600; v1 = 180; v2 = 120;
                    }
                    let t1 = distOneWay / v1;
                    let t2 = distOneWay / v2;
                    let avg = Math.round((distOneWay*2) / (t1 + t2));
                    q = {
                        ...sObj,
                        title: "Level 3: å¹³å‡é€Ÿç‡",
                        text: `å“¥å“¥å»è¶…å¸‚è·é›¢ <b>${distOneWay} å…¬å°º</b>ï¼Œå»ç¨‹é€Ÿç‡ <b>${v1} å…¬å°º/åˆ†</b>ï¼Œå›ç¨‹é€Ÿç‡ <b>${v2} å…¬å°º/åˆ†</b>ã€‚<br>è«‹å•å…¨ç¨‹å¹³å‡é€Ÿç‡æ˜¯å¤šå°‘ï¼Ÿ`,
                        ans: avg,
                        unit: "å…¬å°º/åˆ†",
                        opts: genOpts(avg, 12)
                    };
                }
                else {
                    let totalMin = randItem([40, 50, 60, 75, 90, 120]);
                    let speed = randItem([45, 50, 55, 60, 62, 70]);
                    let dist = Math.round(speed * (totalMin/60));
                    if(!Number.isInteger(dist)){
                        totalMin = 40; dist = 38; speed = 57;
                    }
                    q = {
                        ...sObj,
                        title: "Level 3: å¹³å‡é€Ÿç‡",
                        text: `çˆ¸çˆ¸å¾å®¶è£¡åˆ°å…¬å¸è·é›¢ <b>${dist} å…¬é‡Œ</b>ï¼Œå…±èŠ±äº† <b>${totalMin} åˆ†é˜</b>ã€‚<br>è«‹å•å¹³å‡é€Ÿç‡æ˜¯å¤šå°‘ï¼Ÿ`,
                        ans: speed,
                        unit: "å…¬é‡Œ/æ™‚",
                        opts: genOpts(speed, 10)
                    };
                }
            }
            else if(type === 4) {
                const scenarios = [
                    { ch1: "å°å·", ch2: "è­¦å¯Ÿ", emoji: "ğŸš“", scene: "scene-road" },
                    { ch1: "çƒé¾œ", ch2: "å…”å­", emoji: "ğŸ‡", scene: "scene-nature" },
                    { ch1: "å¼Ÿå¼Ÿ", ch2: "å“¥å“¥", emoji: "ğŸƒ", scene: "scene-track" },
                    { ch1: "æ©Ÿè»Š", ch2: "è·‘è»Š", emoji: "ğŸï¸", scene: "scene-road" }
                ];
                let sObj = randItem(scenarios);

                let vSlow = rdm(50, 120);
                let diff = rdm(20, 60);
                let vFast = vSlow + diff;

                let catchTime = rdm(3, 12);
                let distGap = catchTime * diff;

                q = {
                    ...sObj,
                    title: "Level 4: è¿½è¶•å•é¡Œ",
                    text: `${sObj.ch1}åˆ†é€Ÿ <b>${vSlow}m</b>ï¼Œ${sObj.ch2}åˆ†é€Ÿ <b>${vFast}m</b>ã€‚<br>${sObj.ch1}å·²ç¶“å…ˆè·‘äº† <b>${distGap} å…¬å°º</b>ã€‚<br>${sObj.ch2}å¹¾åˆ†é˜å¾Œè¿½ä¸Šï¼Ÿ`,
                    ans: catchTime,
                    unit: "åˆ†é˜",
                    scene: sObj.scene,
                    opts: genOpts(catchTime, 2)
                };
            }
            else if(type === 5) {
                const sub = randItem(["sameDist", "sameTime", "unitCompare"]);
                if(sub === "sameDist"){
                    let dist = randItem([100, 200, 300, 500]);
                    let t1 = rdm(12, 30);
                    let t2 = t1 + rdm(1, 6);
                    q = {
                        emoji: "ğŸ",
                        title: "é€Ÿç‡æ¯”è¼ƒï¼šåŒè·é›¢",
                        text: `ç”²ã€ä¹™éƒ½è·‘ <b>${dist} å…¬å°º</b>ã€‚<br>ç”²èŠ± <b>${t1} ç§’</b>ï¼Œä¹™èŠ± <b>${t2} ç§’</b>ã€‚<br>èª°çš„é€Ÿç‡æ¯”è¼ƒå¿«ï¼Ÿ`,
                        ans: (t1 < t2) ? "ç”²" : "ä¹™",
                        unit: "",
                        scene: "scene-track",
                        opts: shuffle(["ç”²", "ä¹™", "ä¸€æ¨£å¿«", "ç„¡æ³•æ¯”è¼ƒ"]),
                        special: "whoFaster"
                    };
                } else if(sub === "sameTime"){
                    let time = randItem([30, 40, 50, 60]);
                    let d1 = rdm(200, 800);
                    let d2 = d1 + rdm(50, 250);
                    q = {
                        emoji: "â±ï¸",
                        title: "é€Ÿç‡æ¯”è¼ƒï¼šåŒæ™‚é–“",
                        text: `ç”²ã€ä¹™éƒ½è·‘ <b>${time} ç§’</b>ã€‚<br>ç”²è·‘ <b>${d1} å…¬å°º</b>ï¼Œä¹™è·‘ <b>${d2} å…¬å°º</b>ã€‚<br>èª°çš„é€Ÿç‡æ¯”è¼ƒå¿«ï¼Ÿ`,
                        ans: "ä¹™",
                        unit: "",
                        scene: "scene-road",
                        opts: shuffle(["ç”²", "ä¹™", "ä¸€æ¨£å¿«", "ç„¡æ³•æ¯”è¼ƒ"]),
                        special: "whoFaster"
                    };
                } else {
                    const pairs = [
                        { a: {v:150, u:"å…¬å°º/åˆ†"}, b:{v:200, u:"å…¬åˆ†/ç§’"}, faster:"A" },
                        { a: {v:5.1, u:"å…¬é‡Œ/æ™‚"}, b:{v:80, u:"å…¬å°º/åˆ†"}, faster:"A" },
                        { a: {v:54, u:"å…¬é‡Œ/æ™‚"}, b:{v:24, u:"å…¬å°º/ç§’"}, faster:"B" },
                        { a: {v:100, u:"å…¬åˆ†/ç§’"}, b:{v:3.42, u:"å…¬é‡Œ/æ™‚"}, faster:"A" }
                    ];
                    let p = randItem(pairs);
                    q = {
                        emoji: "âš–ï¸",
                        title: "é€Ÿç‡æ¯”è¼ƒï¼šå–®ä½æ›ç®—",
                        text: `ä¸‹åˆ—å“ªä¸€å€‹é€Ÿç‡æ¯”è¼ƒå¿«ï¼Ÿ<br><b>Aï¼š</b>${p.a.v} ${p.a.u}<br><b>Bï¼š</b>${p.b.v} ${p.b.u}`,
                        ans: p.faster,
                        unit: "",
                        scene: "scene-nature",
                        opts: shuffle(["A", "B", "ä¸€æ¨£å¿«", "ç„¡æ³•æ¯”è¼ƒ"]),
                        special: "whichFaster",
                        meta: p
                    };
                }
            }
            else {
                const sub = randItem(["convert", "echo", "tunnel", "fractionLeft"]);
                if(sub === "convert"){
                    let kmh = randItem([18, 36, 54, 72, 90]);
                    let mPerMin = kmh * 1000 / 60;
                    q = {
                        emoji: "ğŸ”„",
                        title: "å–®ä½æ›ç®—",
                        text: `æŠŠ <b>æ™‚é€Ÿ ${kmh} å…¬é‡Œ</b>æ›ç®—æˆ <b>å…¬å°º/åˆ†</b> æ˜¯å¤šå°‘ï¼Ÿ`,
                        ans: mPerMin,
                        unit: "å…¬å°º/åˆ†",
                        scene: "scene-sky",
                        opts: genOpts(mPerMin, Math.max(20, Math.round(mPerMin*0.08)))
                    };
                }
                else if(sub === "echo"){
                    let speed = 1500;
                    let sec = randItem([6, 8, 10, 12]);
                    let distM = speed * sec / 2;
                    let distKm = distM / 1000;
                    q = {
                        emoji: "ğŸ¬",
                        title: "å›è²å®šä½",
                        text: `æµ·è±šåˆ©ç”¨å›è²å®šä½ï¼Œè²éŸ³åœ¨æµ·æ°´ä¸­é€Ÿç‡ç´„ <b>${speed} å…¬å°º/ç§’</b>ã€‚<br>ç™¼å‡ºè²éŸ³å¾Œ <b>${sec} ç§’</b>æ”¶åˆ°å›è²ï¼Œçµç‰©è·é›¢æµ·è±šå¤šå°‘å…¬é‡Œï¼Ÿ`,
                        ans: distKm,
                        unit: "å…¬é‡Œ",
                        scene: "scene-water",
                        opts: genOpts(distKm, 2)
                    };
                }
                else if(sub === "tunnel"){
                    let train = randItem([240, 290, 320]);
                    let tunnel = randItem([180, 210, 250]);
                    let kmh = randItem([72, 90, 108]);
                    let ms = kmh * 1000 / 3600;
                    let totalM = train + tunnel;
                    let sec = totalM / ms;
                    q = {
                        emoji: "ğŸš†",
                        title: "éš§é“ç«è»Š",
                        text: `ç«è»Šé•· <b>${train} å…¬å°º</b>ï¼Œéš§é“é•· <b>${tunnel} å…¬å°º</b>ï¼Œç«è»Šæ™‚é€Ÿ <b>${kmh} å…¬é‡Œ</b>ã€‚<br>å¾è»Šé ­é€²å…¥éš§é“åˆ°è»Šå°¾å®Œå…¨é›¢é–‹ï¼Œå…±èŠ±å¹¾ç§’ï¼Ÿ`,
                        ans: sec,
                        unit: "ç§’",
                        scene: "scene-track",
                        opts: genOpts(sec, 6)
                    };
                }
                else {
                    let total = 2400;
                    let fracNum = 5;
                    let fracDen = 8;
                    let usedMin = 20;
                    let speed = total * fracNum / fracDen / usedMin;
                    let left = total * (1 - fracNum/fracDen);
                    let need = left / speed;
                    q = {
                        emoji: "ğŸš¶â€â™‚ï¸",
                        title: "æŒ‘æˆ°ï¼šèµ°å®Œå¹¾åˆ†ä¹‹å¹¾",
                        text: `ç”²ã€ä¹™å…©åœ°ç›¸è· <b>${total} å…¬å°º</b>ã€‚<br>æ–°ä¸€èŠ± <b>${usedMin} åˆ†é˜</b>èµ°å®Œ <b>${fracNum}/${fracDen}</b> çš„è·¯ç¨‹ã€‚<br>ç¶­æŒåŒæ¨£é€Ÿç‡ï¼Œå‰©ä¸‹çš„è·¯ç¨‹é‚„è¦å¹¾åˆ†é˜ï¼Ÿ`,
                        ans: need,
                        unit: "åˆ†é˜",
                        scene: "scene-road",
                        opts: genOpts(need, 3)
                    };
                }
            }

            gameState.currentQ = q;
            renderQuestion(q);
        }

        function genOpts(ans, variance) {
            let set = new Set([ans]);
            let safeGuard = 0;
            while(set.size < 4 && safeGuard < 90) {
                let diff = (Math.floor(Math.random() * (variance * 2 + 1)) - variance);
                let fake = ans + diff;
                if(fake > 0 && fake !== ans) set.add(fake);
                safeGuard++;
            }
            while(set.size < 4) set.add(ans + set.size + 1);
            return Array.from(set).sort(() => Math.random()-0.5);
        }

        function shuffle(arr){
            return arr.slice().sort(() => Math.random() - 0.5);
        }

        function renderQuestion(q) {
            const sceneEl = document.getElementById('scene-bg');
            sceneEl.className = 'scenario-card ' + (q.scene || 'scene-nature');

            document.getElementById('q-emoji').textContent = q.emoji || "âœ¨";
            document.getElementById('q-title').textContent = q.title || "é¡Œç›®";
            document.getElementById('q-text').innerHTML = q.text || "é¡Œç›®è¼‰å…¥ä¸­...";
            document.getElementById('hud-score').textContent = Math.floor(gameState.score);

            const box = document.getElementById('q-options');
            box.innerHTML = '';

            q.opts.forEach(opt => {
                let btn = document.createElement('div');
                btn.className = 'option-card';
                btn.innerHTML = (q.unit ? `${opt} <small>${q.unit}</small>` : `${opt}`);
                btn.onclick = () => checkAnsUnified(opt);
                box.appendChild(btn);
            });
        }

        // âœ… çµ±ä¸€åˆ¤æ–·ï¼ˆæ•¸å€¼é¡Œ / æ–‡å­—é¡Œ éƒ½å¯ä»¥ï¼‰
        function isCorrect(choice, q){
            // æ–‡å­—é¡Œï¼šans æ˜¯å­—ä¸²
            if(typeof q.ans === "string"){
                return String(choice) === q.ans;
            }
            // æ•¸å€¼é¡Œï¼šå…è¨±å°æ•¸èª¤å·®
            const a = Number(q.ans);
            const c = Number(choice);
            if(Number.isNaN(a) || Number.isNaN(c)) return false;
            return Math.abs(a - c) < 1e-9;
        }

        function prettyAnswer(q){
            if(typeof q.ans === "string") return q.ans;
            const n = Number(q.ans);
            const val = Number.isInteger(n) ? n : (Math.round(n*100)/100);
            return q.unit ? `${val} ${q.unit}` : `${val}`;
        }

        // âœ… ç­”å°ï¼šçµ¦å›é¥‹ â†’ ä¸‹ä¸€é¡Œ
        // âœ… ç­”éŒ¯ï¼šçµ¦æ­£ç¢ºç­”æ¡ˆ â†’ ä¸‹ä¸€é¡Œ
        function checkAnsUnified(choice){
            if(gameState.isPaused) return;
            if(awaitingNext) return; // é˜²é€£é»

            const q = gameState.currentQ;
            const correct = isCorrect(choice, q);

            if(correct){
                gameState.combo++;

                let base = 100;
                if(gameState.difficulty === 'hard') base = 150;
                if(gameState.difficulty === 'easy') base = 80;

                let multiplier = 1 + (gameState.combo * 0.1);
                gameState.score += (base * multiplier);

                updateComboUI();
                document.getElementById('hud-score').textContent = Math.floor(gameState.score);

                const praises = [
                    "æ¼‚äº®ï¼é€™é¡Œåƒåœ¨ä½ æ‰‹å¿ƒæ»‘é âœ¨",
                    "è¶…ç©©ï¼é€Ÿç‡éƒ½è¢«ä½ æ‹¿æ ğŸ˜",
                    "Niceï¼è…¦è¢‹åƒæ¸¦è¼ªä¸€æ¨£è½‰ ğŸ”¥",
                    "ç¥æ“ä½œï¼Jessie ç›´æ¥çµ¦ä½ ä¸€å€‹è®š ğŸ‘"
                ];
                const pick = praises[Math.floor(Math.random()*praises.length)];

                awaitingNext = true;
                pendingNextFn = () => generateNextQuestion();
                showToast({
                    emoji: "âœ…",
                    title: "ç­”å°å•¦ï¼",
                    msg: `${pick}<br><span style="opacity:.85">Comboï¼šx${gameState.combo}ã€€+åˆ†æ•¸å·²å…¥å¸³</span>`,
                    btnText: "ä¸‹ä¸€é¡Œ"
                });

            } else {
                gameState.combo = 0;
                updateComboUI();

                gameState.time -= 10;
                if(gameState.time < 0) gameState.time = 0;
                updateTimerUI();

                const correctText = prettyAnswer(q);

                awaitingNext = true;
                pendingNextFn = () => {
                    // è‹¥æ™‚é–“è¢«æ‰£åˆ° 0ï¼Œç›´æ¥çµç®—
                    if(gameState.time <= 0) endGame();
                    else generateNextQuestion();
                };

                showToast({
                    emoji: "âŒ",
                    title: "å·®ä¸€é»é»ï½",
                    msg: `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<b>${correctText}</b><br><span style="opacity:.85">Combo æ­¸é›¶ï¼Œæ™‚é–“ -10 ç§’</span>`,
                    btnText: (gameState.time <= 0 ? "çµç®—" : "ä¸‹ä¸€é¡Œ")
                });
            }
        }

        function endGame() {
            clearInterval(gameState.timerId);
            gameState.isPaused = false;
            hidePauseOverlay();
            hideToast();
            awaitingNext = false;
            pendingNextFn = null;

            switchScreen('screen-result');

            let finalScore = Math.floor(gameState.score);
            document.getElementById('final-score').textContent = finalScore;

            let stars = 1;
            if(finalScore > 800) stars = 2;
            if(finalScore > 1500) stars = 3;

            const starContainer = document.getElementById('result-stars');
            starContainer.innerHTML = '';
            for(let i=0; i<3; i++) {
                let span = document.createElement('span');
                span.textContent = 'â˜…';
                if(i < stars) span.className = 'filled';
                starContainer.appendChild(span);
            }

            let msg = "";
            if(stars === 3) msg = "å¤ªç¥å•¦ï¼ä½ æ˜¯æ•¸å­¸è¶…äººï¼ğŸ†";
            else if(stars === 2) msg = "å¾ˆæ£’å–”ï¼å†ä¸€é»é»å°±æ»¿åˆ†äº†ï¼âœ¨";
            else msg = "å†æ¥å†å²ï¼Œä¸‹æ¬¡æœƒæ›´å¥½ï¼ğŸ’ª";
            document.getElementById('feedback-msg').textContent = msg;

            saveScore(gameState.name, finalScore);
            renderLeaderboard('selection-leaderboard'); // æ›´æ–°
        }

        function saveScore(name, score) {
            let scores = JSON.parse(localStorage.getItem('jessieMathSpeedScores') || '[]');
            scores.push({ name: name, score: score, date: new Date().toLocaleDateString() });
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 5);
            localStorage.setItem('jessieMathSpeedScores', JSON.stringify(scores));
        }

        function renderLeaderboard(tableId) {
            const table = document.getElementById(tableId);
            if(!table) return;
            const scores = JSON.parse(localStorage.getItem('jessieMathSpeedScores') || '[]');
            let html = `<tr><th>æ’å</th><th>åå­—</th><th>åˆ†æ•¸</th></tr>`;
            if(scores.length === 0) {
                html += `<tr><td colspan="3" style="text-align:center; color:#999;">ç›®å‰é‚„æ²’æœ‰ç´€éŒ„</td></tr>`;
            } else {
                scores.forEach((s, index) => {
                    let rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                    let rankIcon = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : index + 1));
                    html += `<tr class="${rankClass}"><td>${rankIcon}</td><td>${s.name}</td><td>${s.score}</td></tr>`;
                });
            }
            table.innerHTML = html;
        }

        // åˆå§‹ï¼šé¸é—œå¡é æœƒå† renderï¼Œä¸€é–‹å§‹å…ˆå‚™ç”¨
        renderLeaderboard('selection-leaderboard');
    </script>
</body>
</html>
